# 								动态人脸识别服务接口


| 版本号        | 日期       | 编写人员 | 备注     |
| ------------- | ---------- | -------- | -------- |
| 2.3.0_release | 2020/05/29 | 孙华禹   | 初始版本 |

提供如下功能

| 调用方式                         | 功能介绍                    |
| -------------------------------- | --------------------------- |
| POST /recognition/snapshot.php   | 人脸抓拍机图像推送          |
| POST /recognition/snapshot-atlas | atlas视频流解析服务图像推送 |
|                                  |                             |

## 1. 公共部分

### HTTP错误码

| http返回码 | 含义       |
| ---------- | ---------- |
| 0          | 请求成功   |
| 500        | 请求体错误 |
| 1          | 操作失败   |

### HTTP头

| key          | value                          | 请求或相应 |
| ------------ | ------------------------------ | ---------- |
| Content-Type | application/json;charset=utf-8 | 不可为空   |
|              |                                |            |
|              |                                |            |

### 二进制数据
二进制数据包括图像、视频、特征等，均用Base64进行编码。



## 2. 接口部分

### 2.1 抓拍机心跳同步接口 **POST /devicemanagement/php/receivedeviceinfo.php**

```java
public AjaxResult test(@RequestParam(value = "device_name") String deviceName,
                           @RequestParam(value = "ipaddr") String ipaddr, @RequestParam(value = "port") Integer port,
                           @RequestParam(value = "user_name") String userName, @RequestParam(value = "pass_wd") String passwd,
                           @RequestParam(value = "serialno") String serialno, @RequestParam(value = "channel_num", required = false) Integer channel_num)
```

Request定义:

| JSON Path   | 类型    | 含义       | 注意事项 |
| ----------- | ------- | ---------- | -------- |
| deviceName  | String  | 设备名称   | 非必需   |
| ipaddr      | String  | 设备IP     |          |
| port        | String  | 设备端口号 |          |
| user_name   | String  | 登陆用户名 |          |
| pass_wd     | String  | 登陆密码   |          |
| serialno    | String  | 设备序列号 |          |
| channel_num | Integer | 设备通道号 |          |

### 2.2  抓拍机器图像上传接口**POST /recognition/snapshot.php**

```java
public AjaxResult image(@RequestBody ZhenShiImageBean request)
```

Request定义:

| JSON Path                                    | 类型          | 含义           | 注意事项    |
| -------------------------------------------- | ------------- | -------------- | ----------- |
| ZhenShiImageBean.cmd                         | String        | 请求类型       | 非必需      |
| ZhenShiImageBean.id                          | int           | 业务id         | 非必需      |
| ZhenShiImageBean.body                        | JSON          | 数据请求体     | 必需，否则1 |
| ZhenShiImageBean.body.picture                | List<Picture> | 图像信息list   | 必需，否则1 |
| ZhenShiImageBean.body.serialno               | String        | 设备序列号     | 必需        |
| ZhenShiImageBean.body.picture.Picture.type   | int           | 图像类型       | 非必需      |
| ZhenShiImageBean.body.picture.Picture.length | Int           | 图像数据长度   | 必需        |
| ZhenShiImageBean.body.picture.Picture.data   | String        | 图像BASE64数据 | 必需        |

Request示例:

```json
{
    "cmd": "match",
    "id": 1,
    "body": {
        "serialno": "009192512008js",
        "picture": [
            {
                "data": "lksjdglaksdjglaksdjglaksdjglaksjdlkgalkdsg"
            }
        ]
    }
}
```



Response示例:

```json
{
    "msg": "操作成功",
    "code": 0
}
{
    "msg": "操作失败",
    "code": 1
}
```

### 2.3 Atlas设备图像上传接口 **POST /recognition/snapshot-atlas**

```java
public AjaxResult image(@RequestBody String jsonString) throws IOException//请求体为json字符串
```

Request定义:

| JSON Path                         | 类型          | 含义           | 注意事项             |
| --------------------------------- | ------------- | -------------- | -------------------- |
| $.corpId                          | String        | 合作id         | 同设备序列号，非必需 |
| $.strTESn                         | String        | 设备序列号     | 必需                 |
| $.DATA                            | DATA          | 数据请求体     | 必需，否则1          |
| $.DATA.imgType                    | String        | 图像类型       | 非必需               |
| $.DATA.imgFace                    | List<imgFace> | 图像信息list   | 必需，否则1          |
| $.DATA.imgFace.imgFace.img        | String        | 图像BASE64数据 | 必需，否则1          |
| $.DATA.imgFace.imgFace.coordinate | String        | 图像人脸坐标   | 非必需               |
|                                   |               |                |                      |

Request示例:

```json
{
    "corpId": "123",
    "strTESn": "123",
    "DATA": {
        "imgFace": [
            {
                "img": "skgasldkgnalskdngladgasdgas"
            }
        ]
    }
}
```



Response示例:

```json
{
    "msg": "操作成功",
    "code": 0
}
{
    "msg": "操作失败",
    "code": 1
}
```

 ### 2.4 测温设备图像识别回调接口 **FMSGCallBack_V31**

```java
public class FMSGCallBack_V31 implements HCNetSDK.FMSGCallBack_V31{
  @Override
    public boolean invoke(int lCommand, HCNetSDK.NET_DVR_ALARMER pAlarmer, Pointer pAlarmInfo, int dwBufLen,
            Pointer pUser) {
        LOGGER.info("触发回调,内部触发类型[{}]", lCommand);
        this.alarmDataHandle(lCommand, pAlarmer, pAlarmInfo, dwBufLen, pUser);
        return true;
    }
  private void alarmDataHandle(int lCommand, HCNetSDK.NET_DVR_ALARMER pAlarmer, Pointer pAlarmInfo, int dwBufLen,
            Pointer pUser) {
    //do something
  }
}
```

该接口为测温设备注册后设备触发报警后的特定类型的回调接口，为测温设备定制

### 2.5 识别结果对外推送 **POST /msg/receive**

修改eyecool-abis-admin-1.0.0应用配置文件application.yml

1. 开启人脸识别结果推送开关

   ```yaml
   [[abis]].bio.message.send.switch=true
   [[注意，yml]]文件中的格式为：
   abis:
   	bio:
   		message:
   			send:
   				switch: true
   ```

2. 指定/修改接收人脸识别结果的http服务地址

   ```yaml
   [[abis]].bio.message.send.url=http://ip:port/xxxx/msg/receive(示例)
   [[注意，yml]]文件中的格式如下：
   abis:
   	bio:
   		message:
   			send:
   				url: http://ip:port/xxxx/msg/receive(示例)
   ```

3. 启动eyecool-abis-dfs应用 开启推送人脸识别结果后，有识别结果时，按上述的配置会发送消息到 http://ip:port/xxxx/msg/receive(示例) 这个地址

4. 推送数据定义

   | 字段名称         | 类型   | 是否必须 | 描述                          |
   | ---------------- | ------ | -------- | ----------------------------- |
   | personCode       | string | 是       | 人员编号                      |
   | result           | string | 是       | 识别结果，默认为“1”，识别通过 |
   | score            | string | 是       | 比对分数                      |
   | matchTime        | string | 是       | 比对时间                      |
   | deviceNo         | string | 是       | 设备编号                      |
   | liveFaceDataB64  | string | 否       | 现场人脸图base64              |
   | tmplImageDataB64 | string | 否       | 模板图base64                  |
   | deviceAddr       | String | 否       | 设备具体地址                  |

5. 发送数据示例

   ```json
   {
   	"personCode":"liqiang",
   	"result":"1",
   	"score":"100",
   	"matchTime":"2019-10-10 12:12:12",
   	"deviceNo":"FRB-10",
   	"liveFaceDataB64":"..............",
   	"tmplImageDataB64":"...............",
       "deviceAddr":"..............."
   }
   ```

### 2.6 人员命中识别结果推送接口 **websocket /topic/pullhitresult**

推送数据结构

| JSON Path   | 类型   | 含义             |      |
| ----------- | ------ | ---------------- | ---- |
| featureId   | String | 特征id           |      |
| personCode  | String | 人员唯一标识     |      |
| matchTime   | String | 比对时间         |      |
| deviceNo    | String | 设备编号         |      |
| imageUrl    | String | 图像本地存储地址 |      |
| imageB64    | String | 图像Base64数据   |      |
| personName  | String | 人员姓名         |      |
| score       | double | 比对分数         |      |
| tmplImageId | String | 人员模版图像id   |      |
| comment     | String | 温度相关数据     |      |

### 2.7 陌生人识别结果推送接口 **websocket /topic/pullstrangerresult**

推送数据结构

| JSON Path | 类型   | 含义             |      |
| --------- | ------ | ---------------- | ---- |
| matchTime | String | 比对时间         |      |
| deviceNo  | String | 设备编号         |      |
| imageUrl  | String | 图像本地存储地址 |      |
| comment   | String | 温度相关数据     |      |

### 2.8 统计分析概览数据展示接口 **POST /statistics/center**

返回数据结构

| JSON Path               | 类型    | 含义               |      |
| ----------------------- | ------- | ------------------ | ---- |
| yesterdayIdentifyNumber | Integer | 昨日识别人次       |      |
| todayIdentifyNumber     | Integer | 昨日识别人数       |      |
| yesterdayIdentifyPeople | Integer | 昨日识别人数       |      |
| todayIdentifyPeople     | Integer | 今日识别人数       |      |
| totalUserGroup          | Integer | 人员库总数         |      |
| totalUserRepeat         | Integer | 人员库重复人员数   |      |
| totalUserNormal         | Integer | 状态正常人员数     |      |
| personWithNoReference   | Integer | 状态异常人员数     |      |
| personWithNoGroup       | Integer | 未分配人员库人员数 |      |
| onLineDevices           | Integer | 在线设备数         |      |
| offLineDevices          | Integer | 离线设备数         |      |

### 2.9 统计分析概览数据展示接口 POST /statistics/data/center**

返回数据结构

| JSON Path         | 类型                | 含义                 |      |
| ----------------- | ------------------- | -------------------- | ---- |
| groupPerson       | List<String,String> | 各分库人员数         |      |
| personNumTrend    | List<String,String> | 识别人次按日分布数据 |      |
| personPeopleTrend | List<String,String> | 识别人数按日分布数据 |      |

