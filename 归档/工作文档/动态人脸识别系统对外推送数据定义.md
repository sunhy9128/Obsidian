# 动态人脸识别系统对外推送数据定义





##### **说明**

动态人脸识别系统支持将识别结果推送至其他第三方系统或者自定义展示端

注：动态人脸识别系统为了方便第三方获取人脸识别结果，故提供了对外的 HTTP 实时识别结果推送协议，协议中动态人脸识别系统作为对应的客户端，需要配置相应的 HTTP 服务端信息才能完成对应的实时消息推送

##### **识别结果推送HTTP** 

1. 推送人脸识别结果

2. HTTP 的请求地址，POST 请求

   ```http
   http://ip:port/xxxx/msg/receive
   Content-type: application/json
   ```

###### **修改配置**

修改eyecool-abis-admin-1.0.0应用配置文件application.yml

1. 开启人脸识别结果推送开关

   ```yaml
   [[abis]].bio.message.send.switch=true
   [[注意，yml]]文件中的格式为：
   abis:
   	bio:
   		message:
   			send:
   				switch: true
   ```

2. 指定/修改接收人脸识别结果的http服务地址

   ```yaml
   [[abis]].bio.message.send.url=http://ip:port/xxxx/msg/receive(示例)
   [[注意，yml]]文件中的格式如下：
   abis:
   	bio:
   		message:
   			send:
   				url: http://ip:port/xxxx/msg/receive(示例)
   ```

3. 启动eyecool-abis-dfs应用 开启推送人脸识别结果后，有识别结果时，按上述的配置会发送消息到 http://ip:port/xxxx/msg/receive(示例) 这个地址

4. 推送数据定义

   | 字段名称         | 类型   | 是否必须 | 描述                          |
   | ---------------- | ------ | -------- | ----------------------------- |
   | personCode       | string | 是       | 人员编号                      |
   | result           | string | 是       | 识别结果，默认为“1”，识别通过 |
   | score            | string | 是       | 比对分数                      |
   | matchTime        | string | 是       | 比对时间                      |
   | deviceNo         | string | 是       | 设备编号                      |
   | liveFaceDataB64  | string | 否       | 现场人脸图base64              |
   | tmplImageDataB64 | string | 否       | 模板图base64                  |
   | deviceAddr       | String | 否       | 设备具体地址                  |

5. 发送数据示例

   ```json
   {
   	"personCode":"liqiang",
   	"result":"1",
   	"score":"100",
   	"matchTime":"2019-10-10 12:12:12",
   	"deviceNo":"FRB-10",
   	"liveFaceDataB64":"..............",
   	"tmplImageDataB64":"...............",
       "deviceAddr":"..............."
   }
   ```

6. http服务代码示例

   ```java
   @RequestMapping(value = "/msg/receive", produces = "application/json;charset=utf-8")
       @ResponseBody
       public Res testReceiveMsg(@RequestBody Map<String, Object> params) throws InterruptedException {
           LOG.info("presonId = {}, result = {}, score={}, matchTime={}, deviceNo={}, liveFaceDatB64 ={}, tmplImageDataB64 ={}, deviceAddr={}", params.get("personId"), params.get("result"), params.get("score"), params.get("matchTime"), params.get("deviceNo"), StringUtils.isEmpty((String) params.get("liveFaceDataB64")) ? null : (String) params.get("liveFaceDataB64"), StringUtils.isEmpty((String) params.get("tmplImageDataB64")) ? null : (String) params.get("tmplImageDataB64"), StringUtils.isEmpty((String) params.get("deviceAddr")) ? null : params.get("deviceAddr"));
           Res res = new Res();
           res.setCode("0000");
           res.setMsg("success");
           return res;
       }
       class Res {
           String code;
           String msg;
           public String getCode() {
               return code;
           }
           public void setCode(String code) {
               this.code = code;
           }
           public String getMsg() {
               return msg;
           }
           public void setMsg(String msg) {
               this.msg = msg;
           }
       }
   ```

##### **展示信息推送（websocket）**

```
协议：websocket
图像显示url：/bio/image/show?storeFlag=1&url=imageUrl
```

###### **陌生人**

| 字段名称  | 类型   | 描述                     |
| --------- | ------ | ------------------------ |
| matchTime | string | 时间 yyyy-MM-dd HH:mm:ss |
| deviceNo  | string | 设备编号                 |
| imageUrl  | string | 抓拍图url                |

###### **命中结果**

| 字段名称    | 类型   | 描述                     |
| ----------- | ------ | ------------------------ |
| personCode  | string | 人员编号                 |
| featureId   | string | 特征id                   |
| personName  | string | 人员姓名                 |
| matchTime   | string | 时间 yyyy-MM-dd HH:mm:ss |
| deviceNo    | string | 设备编号                 |
| tmplImageId | string | 模板图像id               |
| imageUrl    | string | 抓拍图url                |
| score       | double | 比对分数                 |

###### **抓拍图**

| 字段名称  | 类型   | 描述                     |
| --------- | ------ | ------------------------ |
| matchTime | string | 时间 yyyy-MM-dd HH:mm:ss |
| deviceNo  | string | 设备编号                 |
| imageUrl  | string | 抓拍图url                |

###### **H5 websocket展示示例代码**

```js

var imagePreUrl = "/bio/image/show";
// 说明
// SERVER_IP:应用服务器地址
//
// SERVER_PORT:应用服务端口

function openSocket() {
    if (stompClient == null) {
        var socket = new SockJS('http://' + SERVER_IP + ':' + SERVER_PORT + '/websocket?token=kl');
        stompClient = Stomp.over(socket);
        stompClient.connect(
            {
                token: "kl"
            },
            function (frame) {
                stompClient.subscribe('/topic/pullhitresult',
                    function (event) {
                        var content = JSON.parse(event.body);
                        var personCode = content.personCode;
                        var featureId = content.featureId;
                        var imageB64 = content.imageB64;
                        var matchTime = content.matchTime;
                        var deviceNo = content.deviceNo;
                        var personName = content.personName;
                        console.log(personCode);
                        var imageUrl = content.imageUrl;
                        console.log(imageUrl);
                        var finalUrl =
                            encodeURI(imagePreUrl
                                + "?storeFlag=1&url="
                                + imageUrl);
                        if (deviceNo == currentDeviceNo) {
                            var html = "<li><img src = '/img/ic-userimg-mask.png'class = 'userimg-mask' > "
                                + "<img class='user-img' src='" + finalUrl + "'/>"
                                + "<p>"
                                + "<span class = 'username' > "
                                + personName
                                + "</span>"
                                + "<time>"
                                + matchTime
                                + "</time>"
                                + "</p>"
                                + "</li>";
                            $("[[hitresult]]").prepend(html);
                            var tanchuangHtml = " <div class = 'model-box' > "
                                + "<img width='220'height = '220'src = '" + finalUrl + "'width = '256'height = '256' > "
                                + "<p class = 'username' > "
                                + personName
                                + "</p>"
                                + "<date>"
                                + matchTime
                                + "</date>"
                                + "</div>";
                            openModal(tanchuangHtml);
                            if (OPEN_AUDIO) {
                                playAudio();
                            }
                        }
                    },
                    {
                        token: "kltoen"
                    }
                );

                stompClient.subscribe('/topic/pullstrangerresult',
                    function (event) {
                        var content = JSON.parse(event.body);
                        var deviceNo = content.deviceNo;
                        var imageUrl = content.imageUrl;
                        var captureTime = content.matchTime;
                        console.log(imageUrl);
                        var finalUrl = encodeURI(imagePreUrl
                            + "?storeFlag=1&url="
                            + imageUrl);
                        var html = "<div class='return-img'>"
                            + "<img class='person-pic'src = '" + finalUrl + "' / > "
                            + "</div>"
                            + "<p>"
                            + captureTime
                            + "</p>"
                            + "<p>"
                            + deviceNo
                            + "</p>";
                        $("[[strangerresult]]").prepend(html);
                    }, {
                        token: "kltoen"
                    });
                stompClient.subscribe('/topic/pullcaptureresult',
                    function (event) {
                        var content = JSON.parse(event.body);
                        var deviceNo = content.deviceNo;
                        var imageUrl = content.imageUrl;
                        var captureTime = content.matchTime;
                        console.log(imageUrl);
                        var finalUrl =
                            encodeURI(imagePreUrl
                                + "?storeFlag=1&url="
                                + imageUrl);
                        var html = "<div class='return-img'>"
                            + "<img class='person-pic'src = '" + finalUrl + "' / > "
                            + "</div>"
                            + "<p>"
                            + "男-20"
                            + "</p>"
                            + "<p>"
                            + captureTime
                            + "</p>"
                            + "<p>"
                            + deviceNo
                            + "</p>";
                        $("[[captureresult]]").prepend(html);
                    }, {
                        token: "kltoen"
                    });
            });
    }
}
```

